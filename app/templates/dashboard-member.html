<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Member Dashboard | Temp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    #foodSuggestions {
      position: absolute;
      z-index: 1000;
      width: 100%;
      max-height: 250px;
      overflow-y: auto;
      display: none;
    }
  </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand ms-auto fw" href="{{ url_for('main.home') }}">Temp</a>
    <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-light ms-3">Log Out</a>
  </div>
</nav>

<div class="container mt-4">
  <h1 class="mb-4">Welcome back, {{ user.first_name }}!</h1>

  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 mb-3">
      <div class="list-group">
        <a href="{{ url_for('member.dashboard') }}" class="list-group-item list-group-item-action active">Dashboard</a>
        <a href="{{ url_for('member.view_progress') }}" class="list-group-item list-group-item-action">View Progress</a>
        <a href="{{ url_for('member.exercise_plan') }}" class="list-group-item list-group-item-action">Exercise Plan</a>
      </div>
    </div>

    <!-- Main content -->
    <div class="col-md-9 position-relative">
      <h3>Macronutrient Tracker</h3>

      <!-- Add Food Form -->
      <form method="POST" class="mb-4">
        <div class="input-group">
          <input type="text" id="food_search" name="food_search" class="form-control" placeholder="Search food..." autocomplete="off" required>
          <input type="number" step="0.01" name="log_quantity" class="form-control" placeholder="Quantity (grams)" required>
          <input type="hidden" name="food_id" id="food_id">
          <button type="submit" class="btn btn-primary">Add</button>
        </div>
        <div id="foodSuggestions" class="list-group shadow-sm"></div>
      </form>

      <!-- Add Custom Food Form -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Add Custom Food</h5>
          <form method="POST" action="{{ url_for('member.add_custom_food') }}">
            <div class="mb-2">
              <input type="text" name="custom_name" class="form-control" placeholder="Food Name" required>
            </div>
            <div class="row">
              <div class="col">
                <input type="number" step="0.01" name="calories" class="form-control" placeholder="Calories (kcal)" required>
              </div>
              <div class="col">
                <input type="number" step="0.01" name="protein_g" class="form-control" placeholder="Protein (g)" required>
              </div>
              <div class="col">
                <input type="number" step="0.01" name="carbs_g" class="form-control" placeholder="Carbs (g)" required>
              </div>
              <div class="col">
                <input type="number" step="0.01" name="fats_g" class="form-control" placeholder="Fat (g)" required>
              </div>
            </div>
            <button type="submit" class="btn btn-success mt-2">Add Custom Food</button>
          </form>
        </div>
      </div>

      <!-- Display Logged Foods -->
      {% if user_food_logs %}
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Food</th>
            <th>Quantity (g)</th>
            <th>Calories</th>
            <th>Protein</th>
            <th>Carbs</th>
            <th>Fat</th>
          </tr>
        </thead>
        <tbody>
          {% for log in user_food_logs %}
          <tr>
            <td>{{ log.food.name }}</td>
            <td>{{ log.quantity }}</td>
            <td>{{ (log.quantity / 100) * log.food.calories | round(1) }}</td>
            <td>{{ (log.quantity / 100) * log.food.protein_g | round(1) }}</td>
            <td>{{ (log.quantity / 100) * log.food.carbs_g | round(1) }}</td>
            <td>{{ (log.quantity / 100) * log.food.fats_g | round(1) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Totals -->
      <div class="mt-3">
        <h5>Totals for today:</h5>
        <p>
          Calories: {{ totals.calories | round(1) }} kcal |
          Protein: {{ totals.protein | round(1) }} g |
          Carbs: {{ totals.carbs | round(1) }} g |
          Fat: {{ totals.fat | round(1) }} g
        </p>
      </div>
      {% else %}
      <p>No foods logged yet today.</p>
      {% endif %}
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const searchInput = document.getElementById("food_search");
  const suggestionsBox = document.getElementById("foodSuggestions");
  const foodIdInput = document.getElementById("food_id");

  searchInput.addEventListener("input", async () => {
    const query = searchInput.value.trim();
    foodIdInput.value = "";

    if (query.length < 2) {
      suggestionsBox.style.display = "none";
      return;
    }

    const res = await fetch(`/member/search-foods?q=${encodeURIComponent(query)}`);
    const data = await res.json();

    suggestionsBox.innerHTML = "";
    if (data.results.length === 0) {
      suggestionsBox.style.display = "none";
      return;
    }

    data.results.forEach(food => {
      const item = document.createElement("a");
      item.href = "#";
      item.className = "list-group-item list-group-item-action";
      item.textContent = `${food.name} â€” ${food.calories || 0} kcal | P:${food.protein_g || 0}g C:${food.carbs_g || 0}g F:${food.fats_g || 0}g`;
      item.onclick = (e) => {
        e.preventDefault();
        searchInput.value = food.name;
        foodIdInput.value = food.id;
        suggestionsBox.style.display = "none";
      };
      suggestionsBox.appendChild(item);
    });

    suggestionsBox.style.display = "block";
  });

  document.addEventListener("click", e => {
    if (!suggestionsBox.contains(e.target) && e.target !== searchInput) {
      suggestionsBox.style.display = "none";
    }
  });
</script>
</body>
</html>
